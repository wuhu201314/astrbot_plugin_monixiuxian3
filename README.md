# AstrBot 插件：模拟修仙 v2

<p align="center">
  <img src="logo.png" alt="模拟修仙" width="200">
</p>

> **版本:** v2.10.0  
> **许可证:** AGPL-3.0  
> **作者:** xiaojuwa  
> **基于:** [nonebot_plugin_xiuxian_2](https://github.com/xiuxian-2/nonebot_plugin_xiuxian_2) (部分借鉴与重构)

一款为 AstrBot 设计的、功能丰富的放置类修仙游戏插件。让你在聊天群中体验从凡人到大能的修行之路，工作摸鱼、畅聊吹水的同时亦可得道飞升！

---

## 🌟 特色功能

### 核心玩法
| 系统 | 说明 |
|------|------|
| **境界修炼** | 练气→筑基→金丹→元婴→化神→炼虚→合体→大乘→渡劫，九大境界逐步突破 |
| **战斗系统** | HP/MP/ATK/暴击/防御 真实计算，支持 PVP（切磋/决斗）和 PVE |
| **宗门系统** | 创建/加入宗门，职位管理，宗门建设与捐献 |
| **世界Boss** | 全服Boss降临，多人合力讨伐，按伤害排名瓜分奖励 |
| **秘境探索** | 挂机式秘境探索，获取丰厚修为与灵石 |
| **历练系统** | 离线挂机获取收益，短途/中途/长途三种时长 |
| **炼丹系统** | 收集材料炼制丹药，提升修为或增加属性 |
| **传承系统** | 传承挑战争夺Buff加成，传承排行榜竞技 |

### 独有系统
| 系统 | 说明 |
|------|------|
| **🏔️ 洞天福地** | 个人修炼空间，5档洞天可选，持续产出灵石和修为 |
| **🌾 灵田种植** | 开垦灵田种植灵草，5种灵草不同收益周期 |
| **💕 双修系统** | 与他人双修互增10%修为，1小时冷却 |
| **👁️ 天地灵眼** | 抢占灵眼持续获益，PVP资源争夺玩法 |
| **🗼 通天塔** | 无尽挑战塔，层层递进，积分兑换稀有物品 |
| **👥 社交系统** | 师徒传承、道侣双修、论道切磋 |
| **🧧 仙缘红包** | 群内发红包抢红包，增进互动 |
| **🏴 黑市** | 全丹药购买，价格翻倍，每日限购5颗 |

---

## 📜 指令大全

### 📖 入门 & 基础
| 指令 | 说明 |
|------|------|
| `我要修仙 [灵修/体修]` | 创建角色，灵修擅法术，体修擅肉身 |
| `我的信息` | 显示境界、修为、战力、装备等完整面板 |
| `签到` | 每日领取灵石(50-200)和修为奖励 |
| `改道号 <名称>` | 修改你的仙道称号 |

### 🧘 修炼突破
| 指令 | 说明 |
|------|------|
| `闭关` | 开始闭关修炼，离线也可积累修为 |
| `出关` | 结算闭关时间，获取对应修为 |
| `突破信息` | 查看当前境界突破所需修为、成功率、风险 |
| `突破 [丹药名]` | 尝试突破，可服用丹药增加成功率 |

### 🎒 装备丹药
| 指令 | 说明 |
|------|------|
| `我的装备` | 显示已装备的武器/防具/心法 |
| `装备 <名>` | 从储物戒装备到身上 |
| `卸下 <名>` | 卸下装备放回储物戒 |
| `丹药背包` | 查看拥有的丹药及效果 |
| `服用丹药 <名>` | 使用丹药获得增益 |

### 🏪 商店系统
| 指令 | 说明 |
|------|------|
| `丹阁` | 丹药专卖(破境丹/修为丹/功能丹) |
| `器阁` | 装备专卖(武器/防具/饰品) |
| `百宝阁` | 综合商店(功法/材料/杂物) |
| `购买 <物品名> [数量]` | 从当前商店购买物品 |
| `储物戒` | 查看你的储物空间和物品（分类显示） |
| `存入 <物品名> [数量]` | 存入物品到储物戒 |
| `取出 <物品名> [数量]` | 从储物戒取出物品 |
| `搜索物品 <关键词>` | 模糊搜索储物戒物品 |
| `取出所有 <分类>` | 批量取出指定分类（材料/装备/功法/其他） |
| `更换储物戒 <名称>` | 升级储物戒（需支付灵石） |
| `赠予 <@某人> <物品> [数量]` | 将物品赠送给其他玩家 |

### 🏦 灵石银行
年利率5%，每日复利

| 指令 | 说明 |
|------|------|
| `银行` | 查看存款余额和待领利息 |
| `存灵石 <数量>` | 存入灵石，开始计息 |
| `取灵石 <数量>` | 取出存款 |
| `领取利息` | 每日可领一次利息 |

### 📜 悬赏任务
| 指令 | 说明 |
|------|------|
| `悬赏令` | 查看当前可接取的悬赏任务 |
| `接取悬赏 <编号>` | 接取指定任务 |
| `悬赏状态` | 查看任务进度 |
| `完成悬赏` | 提交任务领取奖励 |
| `放弃悬赏` | 放弃当前任务 |

### 🏛️ 宗门系统
| 指令 | 说明 |
|------|------|
| `创建宗门 <名>` | 消耗灵石创建宗门 |
| `加入宗门 <名>` | 加入已有宗门 |
| `我的宗门` | 查看宗门信息和成员 |
| `宗门列表` | 查看所有宗门排名 |
| `退出宗门` | 退出当前宗门 |
| `宗门捐献 <数量>` | 捐献灵石增加宗门建设度 |

### ⚔️ 战斗竞技
| 指令 | 说明 |
|------|------|
| `切磋 <@某人>` | 友好切磋，无损失 |
| `决斗 <@某人>` | 生死之战，败者损修为 |
| `世界Boss` | 查看Boss信息和血量 |
| `挑战Boss` | 挑战Boss获取丰厚奖励 |
| `传承挑战 <@某人>` | 争夺对方传承加成 |
| `传承排行` | 查看传承榜 |

### 📊 排行榜
| 指令 | 说明 |
|------|------|
| `境界排行` | 查看境界排行榜 |
| `战力排行` | 查看战力排行榜 |
| `灵石排行` | 查看灵石排行榜 |
| `宗门排行` | 查看宗门排行榜 |

### 🚶 历练系统
| 指令 | 说明 |
|------|------|
| `开始历练 [短途/中途/长途]` | 短途30分/中途1小时/长途2小时 |
| `历练状态` | 查看历练进度 |
| `完成历练` | 领取历练奖励 |
| `历练信息` | 查看事件概率说明 |

### 🌀 秘境探索
| 指令 | 说明 |
|------|------|
| `秘境列表` | 查看可探索秘境及奖励 |
| `探索秘境 <ID>` | 进入秘境探险 |
| `完成探索` | 领取秘境奖励 |
| `退出秘境` | 放弃探索(无奖励) |

### 🔥 炼丹系统
| 指令 | 说明 |
|------|------|
| `丹药配方` | 查看炼丹配方及成功率 |
| `炼丹 <配方ID>` | 炼制丹药（成功后存入丹药背包） |

### ✨ 传承系统
| 指令 | 说明 |
|------|------|
| `传承信息` | 查看传承给你的属性加成 |

### 🏔️ 洞天福地
| 指令 | 说明 |
|------|------|
| `我的洞天` | 查看洞天信息和待收取收益 |
| `购买洞天 <1-5>` | 1:小洞天 2:中洞天 3:大洞天 4:福地 5:洞天福地 |
| `升级洞天` | 提升洞天等级增加收益 |
| `洞天收取` | 收取灵石和修为产出 |

**洞天类型：**
| 类型 | 价格 | 修炼加成 |
|------|------|----------|
| 小洞天 | 10,000灵石 | +5% |
| 中洞天 | 50,000灵石 | +10% |
| 大洞天 | 200,000灵石 | +20% |
| 福地 | 500,000灵石 | +30% |
| 洞天福地 | 1,000,000灵石 | +50% |

### 🌾 灵田种植
| 指令 | 说明 |
|------|------|
| `我的灵田` | 查看灵田和种植情况 |
| `开垦灵田` | 花费灵石开垦灵田 |
| `种植 <灵草名>` | 种植灵草 |
| `收获` | 收获成熟的灵草获取修为 |
| `升级灵田` | 增加种植格数 |

**可种植灵草：**
| 灵草 | 成熟时间 | 修为收益 |
|------|----------|----------|
| 灵草 | 1小时 | +500 |
| 血灵草 | 2小时 | +1,500 |
| 冰心草 | 4小时 | +4,000 |
| 火焰花 | 8小时 | +10,000 |
| 九叶灵芝 | 24小时 | +30,000 |

### 💕 双修系统
| 指令 | 说明 |
|------|------|
| `双修 <@某人>` | 向对方发起双修请求 |
| `接受双修` | 接受双修，双方各获10%修为 |
| `拒绝双修` | 拒绝对方请求 |

### 👁️ 天地灵眼
| 指令 | 说明 |
|------|------|
| `灵眼信息` | 查看灵眼及可抢占列表 |
| `抢占灵眼 <ID>` | 占据无主灵眼 |
| `灵眼收取` | 收取灵眼修为产出 |
| `释放灵眼` | 释放已占据的灵眼 |

### 🗼 通天塔
| 指令 | 说明 |
|------|------|
| `挑战通天塔` | 逐层挑战通天塔 |
| `速通通天塔 [层数]` | 快速挑战多层 |
| `通天塔信息` | 查看当前进度和积分 |
| `通天塔BOSS` | 查看当前层Boss信息 |
| `通天塔排行榜` | 查看层数排行 |
| `通天塔积分排行榜` | 查看积分排行 |
| `通天塔商店` | 查看积分兑换商品 |
| `通天塔兑换 <编号>` | 兑换商品 |

### 👥 社交系统
| 指令 | 说明 |
|------|------|
| `收徒 @某人` | 收对方为徒（需境界高于对方） |
| `拜师 @某人` | 拜对方为师 |
| `师徒信息` | 查看师徒关系 |
| `离开师门` | 脱离师门 |
| `求道侣 @某人` | 向对方求为道侣（5000灵石） |
| `接受道侣` / `拒绝道侣` | 回应道侣请求 |
| `解除道侣` | 解除道侣关系 |
| `道侣信息` | 查看道侣信息 |
| `论道 @某人` | 与他人论道获取修为 |

### 💰 灵石互动
| 指令 | 说明 |
|------|------|
| `送灵石 @某人/道号 <数量>` | 赠送灵石给他人 |
| `偷灵石 @某人/道号` | 偷取他人灵石（有失败风险） |
| `抢灵石 @某人/道号` | 强抢他人灵石（有反噬风险） |
| `灵石互动` | 查看互动规则说明 |

### 🧧 仙缘红包
| 指令 | 说明 |
|------|------|
| `送仙缘 <金额> <份数> [祝福语]` | 发送红包 |
| `抢仙缘` | 抢红包 |
| `仙缘说明` | 查看红包规则 |

**红包规则：**
- 最少发送 100 灵石
- 份数范围 1-50 份
- 红包 1 小时后过期
- 过期未抢完自动退还

### 🏴 黑市
| 指令 | 说明 |
|------|------|
| `黑市` | 查看所有可购买丹药（价格翻倍） |
| `黑市购买 <丹药名> [数量]` | 购买丹药 |

**黑市特点：**
- 所有丹药均可购买，无需等待商店刷新
- 价格为原价的 200%（贵100%）
- 每日限购 5 颗（所有丹药共享额度）

---

## ⚙️ 配置说明

插件首次运行后，将在 `data/plugins/astrbot_plugin_monixiuxian2/config/` 目录下自动生成默认配置文件：

| 配置文件 | 作用 |
|---------|------|
| `sect_config.json` | 宗门创建消耗、职位权限、任务奖励 |
| `boss_config.json` | Boss 属性成长曲线、生成间隔 |
| `rift_config.json` | 秘境名称、等级要求、探索时长、奖励池 |
| `alchemy_config.json` | 丹药配方、材料消耗、成功率计算 |

**注意**：修改配置后需重启 AstrBot 生效。

---

## 🖼️ 开启图片卡片 (可选)

本插件支持生成精美个人信息卡片：

1. **安装依赖**: `pip install Pillow`
2. **获取素材**: 下载[卡图资源包](https://cowtransfer.com/s/82b90d2b879d43) (口令：k3jzr5)
3. **放置素材**: 解压后将 `xiuxian` 文件夹放入 AstrBot 的 `data/` 目录中
4. **生效验证**: 发送 `/我的信息`，若配置正确将发送图片

---

## 🛠️ 安装与部署

1. 确保已安装 AstrBot
2. 将插件文件夹放入 `data/plugins/` 目录
3. 安装依赖：`pip install -r requirements.txt`
4. 在 AstrBot 控制台启用插件
5. 发送 `我要修仙` 开始体验！

---

## 📁 项目结构

```
astrbot_plugin_monixiuxian2/
├── main.py                    # 插件入口，命令注册
├── config_manager.py          # 配置管理器
├── models.py                  # 玩家数据模型
├── models_extended.py         # 扩展数据模型
│
├── config/                    # 游戏配置文件（15个）
│   ├── level_config.json      # 境界配置
│   ├── body_level_config.json # 体修境界配置
│   ├── pills.json             # 破境丹配置
│   ├── exp_pills.json         # 修为丹配置
│   ├── utility_pills.json     # 功能丹配置
│   ├── weapons.json           # 武器配置
│   ├── items.json             # 物品配置
│   ├── storage_rings.json     # 储物戒配置
│   ├── boss_config.json       # Boss配置
│   ├── rift_config.json       # 秘境配置
│   ├── sect_config.json       # 宗门配置
│   ├── tower_config.json      # 通天塔配置
│   ├── alchemy_config.json    # 炼丹配置
│   ├── alchemy_recipes.json   # 丹方配置
│   └── game_config.json       # 游戏通用配置
│
├── core/                      # 核心业务逻辑（6个）
│   ├── breakthrough_manager.py # 突破管理
│   ├── cultivation_manager.py  # 修炼管理
│   ├── equipment_manager.py    # 装备管理
│   ├── pill_manager.py         # 丹药管理
│   ├── shop_manager.py         # 商店管理
│   └── storage_ring_manager.py # 储物戒管理
│
├── data/                      # 数据层（4个）
│   ├── data_manager.py        # 数据库操作
│   ├── database_extended.py   # 扩展数据库操作
│   ├── migration.py           # 数据库迁移（v24）
│   └── default_configs.py     # 默认配置
│
├── handlers/                  # 命令处理器（34个）
│   ├── player_handler.py      # 玩家基础
│   ├── misc_handler.py        # 帮助信息
│   ├── equipment_handler.py   # 装备
│   ├── breakthrough_handler.py # 突破
│   ├── pill_handler.py        # 丹药
│   ├── shop_handler.py        # 商店
│   ├── storage_ring_handler.py # 储物戒
│   ├── sect_handlers.py       # 宗门
│   ├── boss_handlers.py       # Boss
│   ├── combat_handlers.py     # 战斗
│   ├── ranking_handlers.py    # 排行榜
│   ├── rift_handlers.py       # 秘境
│   ├── adventure_handlers.py  # 历练
│   ├── alchemy_handlers.py    # 炼丹
│   ├── impart_handlers.py     # 传承
│   ├── impart_pk_handlers.py  # 传承PK
│   ├── nickname_handler.py    # 道号
│   ├── bank_handlers.py       # 银行
│   ├── bounty_handlers.py     # 悬赏
│   ├── blessed_land_handlers.py # 洞天福地
│   ├── spirit_farm_handlers.py  # 灵田
│   ├── dual_cultivation_handlers.py # 双修
│   ├── spirit_eye_handlers.py # 灵眼
│   ├── tribulation_handlers.py # 天劫
│   ├── enlightenment_handlers.py # 悟道
│   ├── fortune_handlers.py    # 福缘
│   ├── inner_demon_handlers.py # 心魔
│   ├── gold_interaction_handlers.py # 灵石互动
│   ├── red_packet_handlers.py # 仙缘红包
│   ├── tower_handlers.py      # 通天塔
│   ├── social_handlers.py     # 社交(师徒/道侣)
│   ├── black_market_handler.py # 黑市
│   └── utils.py               # 处理器工具
│
├── managers/                  # 业务管理器（24个）
│   ├── adventure_manager.py   # 历练
│   ├── alchemy_manager.py     # 炼丹
│   ├── bank_manager.py        # 银行
│   ├── blessed_land_manager.py # 洞天福地
│   ├── boss_manager.py        # Boss
│   ├── bounty_manager.py      # 悬赏
│   ├── combat_manager.py      # 战斗
│   ├── dual_cultivation_manager.py # 双修
│   ├── enlightenment_manager.py # 悟道
│   ├── fortune_manager.py     # 福缘
│   ├── gold_interaction_manager.py # 灵石互动
│   ├── impart_manager.py      # 传承
│   ├── impart_pk_manager.py   # 传承PK
│   ├── inner_demon_manager.py # 心魔
│   ├── ranking_manager.py     # 排行榜
│   ├── red_packet_manager.py  # 仙缘红包
│   ├── rift_manager.py        # 秘境
│   ├── sect_manager.py        # 宗门
│   ├── social_manager.py      # 社交
│   ├── spirit_eye_manager.py  # 灵眼
│   ├── spirit_farm_manager.py # 灵田
│   ├── tower_manager.py       # 通天塔
│   └── tribulation_manager.py # 天劫
│
└── utils/                     # 工具类
    ├── config_loader.py       # 配置加载
    └── image_generator.py     # 图片生成
```

---

## 🤝 致谢

- **原版参考**: [NoneBot-Plugin-Xiuxian-2](https://github.com/xiuxian-2/nonebot_plugin_xiuxian_2)
- **原 AstrBot 插件维护者**: [linjianyan0229](https://github.com/linjianyan0229)

---

## 📝 更新日志

### v2.10.0 - 黑市系统 & 多项修复

**🆕 新功能**
| 功能 | 说明 |
|------|------|
| 🏴 黑市系统 | 可购买所有丹药，价格翻倍，每日限购5颗 |
| 仙缘红包延时 | 红包过期时间从5分钟延长至1小时 |

**🔧 Bug修复**
| 问题 | 修复 |
|------|------|
| 银行存取灵石参数不生效 | 从原始消息解析金额参数 |
| 购买洞天参数不生效 | 从原始消息解析洞天类型 |
| 开垦灵田报错(缺少level列) | 添加v22数据库迁移修复 |
| 开垦灵田报错(缺少crops列) | 添加v24数据库迁移修复 |
| 购买洞天报错(缺少land_name列) | 添加v23数据库迁移修复 |
| 黑市获取丹药方法错误 | 修复ConfigManager丹药数据获取 |

**📊 数据库迁移**
- v22: 修复灵田表缺少level/crops列
- v23: 修复洞天福地表缺少多个列
- v24: 补充修复灵田表crops列

---

### v2.9.5 - 悬赏系统安全加固

**🔴 BUG修复**
| 问题 | 修复位置 | 说明 |
|------|----------|------|
| 战力排行榜与玩家信息战力不一致 | ranking_manager.py | 统一战力计算公式为：物伤+法伤+物防+法防+精神力/10 |
| 战力排行未考虑装备加成 | ranking_manager.py | 现在正确计算装备和丹药效果后的总属性 |
| 境界排行显示Lv.X而非境界名称 | ranking_manager.py | 现在显示实际境界名称（如"玄体境初期"） |
| user_id非字符串时切片报错 | ranking_manager.py | 封装`_short_id()`安全方法 |
| 宗门职位索引越界崩溃 | ranking_manager.py | 使用`POSITION_MAP`安全映射 |
| 宗门排行依赖DB隐式排序 | ranking_manager.py | 显式按建设度排序 |

**✨ 新功能**
| 功能 | 说明 |
|------|------|
| 贡献排行 | 新增`贡献排行`指令，查看当前宗门成员贡献度排行 |

**🛡️ 安全性优化**
| 优化项 | 说明 |
|------|------|
| 名称长度截断 | 道号/宗门名最长12字符，防止刷屏 |
| 特殊字符过滤 | 过滤`@`符号，防止触发群通知 |
| 统一名称处理 | 封装`_safe_name()`方法，所有排行榜统一使用 |

**⚡ 性能优化**
| 优化项 | 说明 |
|------|------|
| EquipmentManager复用 | 初始化时创建一次，避免每次查询重复创建 |

---

### v2.9.2 - 排行榜战力计算修复

**🔴 BUG修复**
| 问题 | 修复位置 | 说明 |
|------|----------|------|
| 战力排行榜与玩家信息战力不一致 | ranking_manager.py | 统一战力计算公式为：物伤+法伤+物防+法防+精神力/10 |
| 战力排行未考虑装备加成 | ranking_manager.py | 现在正确计算装备和丹药效果后的总属性 |
| 战力排行显示ATK而非实际攻击属性 | ranking_manager.py | 根据修炼类型显示物伤(体修)或法伤(灵修) |

---

### v2.9.1 - 系统行为互斥性修复

**🔴 高严重性修复 (状态互斥)**
| 问题 | 修复位置 | 说明 |
|------|----------|------|
| 双重状态系统不同步 | player_handler.py | 闭关/出关时同步更新user_cd表 |
| 历练期间可执行突破 | utils.py | @player_required装饰器增加user_cd状态检查 |
| 历练/秘境期间可发起战斗 | combat_handlers.py | 添加发起者和目标的状态检查 |
| 秘境期间可炼丹 | alchemy_handlers.py | 添加玩家存在和状态检查 |
| 历练期间可加入/退出宗门 | sect_handlers.py | 关键操作添加状态检查 |

**✨ 改进**
- 统一状态检查机制：`@player_required`装饰器现在同时检查`player.state`和`user_cd.type`
- 新增45+条命令白名单，允许在忙碌状态下执行查看类操作（信息查看、银行、背包、排行榜等）
- 状态提示优化：显示具体状态名称（历练中/探索秘境中/宗门任务中等）

---

### v2.9.0 - 安全性与稳定性大修复

**🔴 高严重性修复 (P0)**
| 问题 | 修复位置 | 说明 |
|------|----------|------|
| 储物戒物品来源验证漏洞 | storage_ring_handler.py | 禁用手动存入，物品只能通过系统自动存入 |
| HP/MP计算不一致 | combat_handlers.py | 统一使用 CombatManager.calculate_hp_mp 返回值 |
| 贷款逾期检查并发风险 | utils.py | 添加事务保护防止重复删除玩家 |
| 级联删除不完整 | data_manager.py | 添加 pending_gifts 表的级联删除 |
| 储物戒操作无事务保护 | storage_ring_manager.py | store/retrieve/discard 添加事务保护 |

**🟡 中严重性修复 (P1)**
| 问题 | 修复位置 | 说明 |
|------|----------|------|
| 防御减伤公式不合理 | combat_manager.py | 改用递减公式 defense/(defense+100) |
| 银行利息精度问题 | bank_manager.py | 使用 Decimal 精确复利计算 |
| JSON解析异常处理宽泛 | models.py | 改为 except json.JSONDecodeError |
| 定时任务异常恢复不健壮 | main.py | 添加指数退避重试机制 |
| 购买流程事务不完整 | shop_handler.py | 整个购买流程包装在单一事务中 |

**🟢 低严重性修复 (P2)**
| 问题 | 修复位置 | 说明 |
|------|----------|------|
| 闭关上限固定24小时 | player_handler.py | 根据境界动态调整（24h-72h） |
| 银行配置硬编码 | bank_manager.py | 配置外部化，支持自定义利率等参数 |

**✨ 改进**
- 防御公式优化：100防御=50%减伤，200防御=66%减伤，更合理的递减曲线
- 闭关时长：练气24h → 筑基30h → 金丹36h → ... → 渡劫72h
- 银行配置可在 config 中自定义：利率、存款上限、贷款额度等

---

### v2.7.1 - Bug修复与系统完善

**🔧 Bug修复**
| 问题 | 修复 |
|------|------|
| 炼丹成功后丹药直接使用 | 现在正确存入丹药背包，需手动服用 |
| 赠予指令At解析失败 | 修复At组件解析，兼容多种平台格式 |
| 炼丹配方与配置不匹配 | 配方丹药改为配置文件中实际存在的丹药 |
| 秘境丹药掉落丢失 | 丹药掉落现在正确存入丹药背包而非储物戒 |

**✨ 改进**
- 炼丹成功提示优化：显示"丹药背包"而非"储物戒"
- 删除alchemy_manager中的无效占位方法，统一使用pill_manager
- 炼丹配方更新为：炼气丹、聚灵丹、凝气丹、培元丹、玄灵丹

---

### v2.7.2 - BUG修复

**🔧 修复问题**
- 修复 `update_user_cd` 方法未保存 `extra_data` 字段的问题，导致秘境管理器等功能的额外数据丢失

---

### v2.7.0 - 灵石银行系统完善

🎯 核心改造：银行系统全面升级，新增贷款、流水、排行功能

🏦 银行新功能
| 功能 | 指令 | 说明 |
|------|------|------|
| 贷款 | `/贷款 <金额>` | 普通贷款：0.5%日利率，7天期限 |
| 突破贷款 | `/突破贷款 <金额>` | 高风险贷款：0.8%日利率，3天期限 |
| 还款 | `/还款` | 偿还当前贷款（本金+利息） |
| 银行流水 | `/银行流水` | 查看最近15条交易记录 |
| 存款排行 | `/存款排行` | 查看存款富豪榜 |

---

### v2.6.0 - 突破系统完善

**🎯 核心改造：突破丹药体系重构，全境界覆盖**

**💊 专属破境丹完善**
| 新增丹药 | 目标境界 | 加成效果 |
|---------|----------|---------|
| 固基丹·中/后 | 筑基期内部突破 | +50%/+60% |
| 温丹丹·中/后 | 金丹期内部突破 | +70%/+72% |
| 养婴丹·中/后 | 元婴期内部突破 | +76%/+74% |
| 温神丹·中/后 | 化神期内部突破 | +77%/+78% |
| 破虚丹·中/后 | 炼虚期内部突破 | +79%/+77% |
| 融合丹·中/后 | 合体期内部突破 | +72%/+70% |
| 悟道丹·中/后 | 大乘期内部突破 | +62%/+58% |
| 混元丹 | 混元大罗金仙 | +5% |

**🔄 通用增益丹体系**
- 原"三品筑基丹"等改名为"xx增益丹"，明确定位为通用突破辅助
- 无境界限制，购买后获得1小时临时突破成功率加成
- 可与专属破境丹叠加使用

**🌀 秘境稀有丹药掉落**
| 秘境等级 | 掉落概率 | 可掉落丹药 |
|----------|----------|-----------|
| 低级秘境 | 3% | 三品凝神增益丹 |
| 中级秘境 | 5% | 三/四/五品增益丹 |
| 高级秘境 | 10% | 四/五/六/七品增益丹 |

**🔧 修复问题**
- 修复items.json中`add_breakthrough_bonus`未生效的问题
- 通用增益丹购买后正确添加临时突破加成效果

---

### v2.8.2 - 游戏平衡性与玩法优化

**🔧 修复问题**
| 问题类型 | 修复位置 | 说明 |
|---------|---------|------|
| 战斗防御未应用 | combat_manager.py | PVP和Boss战中玩家防御力现已正确生效 |
| 洞天收益无上限 | blessed_land_manager.py | 添加每小时修为收益上限（5k-100k按洞天等级） |
| 历练收益无上限 | adventure_manager.py | 添加修为/灵石收益上限（按历练类型） |

**🆕 新增功能**
- 灵田枯萎机制：成熟作物48小时未收获将枯萎，增加游戏策略性

---

### v2.8.1 - 安全性与稳定性修复

**🔧 修复问题**
- 修复银行追杀时未级联删除玩家关联数据的问题（灵眼/洞天/灵田/银行等数据残留）

**✅ 已验证修复项**
| 问题类型 | 修复位置 | 说明 |
|---------|---------|------|
| 玩家死亡级联删除 | data_manager.py | 已实现 `delete_player_cascade()` |
| 银行并发事务 | bank_manager.py | 存取款使用 `BEGIN IMMEDIATE` 事务 |
| 双修修为差距限制 | dual_cultivation_manager.py | 限制双方修为差距最大3倍 |
| 灵眼抢占原子操作 | spirit_eye_manager.py | 事务+条件UPDATE防并发 |
| 宗主死亡处理 | sect_manager.py | 自动传位或解散宗门 |
| 装备属性完整应用 | combat_handlers.py | 防具defense已应用到战斗 |
| 悬赏过期处理 | bounty_manager.py | 完成时检查超时自动取消 |
| 宗门名称验证 | sect_manager.py | 长度(2-12字)和敏感词检查 |
| 传承buff应用 | combat_handlers.py | impart加成已应用到战斗 |

---

### v2.9.5 - 悬赏系统安全加固

**🔒 安全修复**
| 问题 | 严重程度 | 修复 |
|------|---------|------|
| 奖励发放与任务完成非原子操作 | 🔴严重 | 使用 `BEGIN IMMEDIATE` 事务保护，防止并发重复领奖 |
| 放弃任务无冷却机制 | 🟠中等 | 放弃悬赏后30分钟内无法接取新任务 |
| 并发领取风险 | 🟠中等 | 事务内先标记完成再发放奖励 |

**🛡️ 事务安全改进**
- `complete_bounty` 现在使用 SQLite 事务保护
- 奖励发放顺序：先标记任务完成 → 再发放灵石/修为 → 最后发放物品
- 物品奖励在事务外处理，失败不影响主奖励

---

### v2.9.4 - 商店购买物品存入储物戒 & 悬赏系统修复

**🔧 修复问题**
| 问题 | 修复 |
|------|------|
| 装备类物品购买后直接装备 | 现在购买的武器/防具/功法/饰品统一存入储物戒 |
| 体修信息面板缺少法伤显示 | 补充显示法伤属性 |
| 突破死亡时删除双修数据报错 | 修复SQL语句中的列名错误 |
| 悬赏任务可无限刷取 | 添加进度检查，必须通过历练/秘境完成任务目标 |

**🆕 悬赏系统改进**
- 悬赏任务现在需要通过实际游戏活动完成进度
- 历练完成：可推进击杀/采集/探索类悬赏
- 秘境探索：可推进探索类悬赏
- 完成历练/秘境后会显示悬赏进度提示

---

### v2.5.0 - 储物戒系统重构

**🎯 核心改造：储物戒成为游戏物品流转的中央枢纽**

**📦 系统联动（8个系统接入）**
| 系统 | 入库场景 | 出库场景 |
|------|---------|---------|
| 商店系统 | 购买物品→自动存入 | - |
| 装备系统 | 卸下装备→存入 | 装备→从储物戒取出 |
| 炼丹系统 | - | 炼丹→消耗储物戒材料 |
| 历练系统 | 完成历练→物品掉落 | - |
| 秘境系统 | 探索完成→物品掉落 | - |
| Boss系统 | 击杀奖励→物品掉落 | - |
| 悬赏系统 | 完成悬赏→物品奖励 | - |
| 灵田系统 | 收获灵草→存入储物戒 | - |

**🆕 新增功能**
- 物品分类视图：按材料/装备/功法/其他分组显示
- 物品搜索：`搜索物品 关键词` 模糊搜索
- 批量取出：`取出所有 分类` 批量操作
- 储物戒升级消耗：需支付灵石购买

**🔧 修复问题**
- 炼丹现在正确消耗储物戒中的灵草材料
- 装备物品必须先存在于储物戒中
- 赠予请求持久化到数据库（24小时有效期）

---

## 📄 许可证

本项目采用 [AGPL-3.0](LICENSE) 许可证。
